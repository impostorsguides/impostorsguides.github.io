<header class="post-header">
  <h1 class="post-title">Introduction</h1>
</header>

<blockquote>"The most effective debugging tool is still careful thought, coupled with judiciously placed print statements." — Brian Kernighan, <a href="https://web.archive.org/web/20220122011437/https://wolfram.schneider.org/bsd/7thEdManVol2/beginners/beginners.pdf" target="_blank"><u>Unix for Beginners</u></a>.</blockquote>

<blockquote>"Don't chase your dreams. Humans are persistence predators. Follow your dreams at a sustainable pace until they get tired and lie down." – <a href="https://bsky.app/profile/raven.corvids.club/post/3k4rcbonfkq2u" target="_blank">@raven.corvids.club (on BlueSky)</a></blockquote>

<h2>Disclaimer</h2>

<p>This is NOT an official guide to RBENV's codebase. It is not written by any member of the RBENV core team, nor is it endorsed by them in any way. It is simply the (sometimes incorrect) educated guesses of a journeyman engineer who wants to attain mastery by <a href="https://www.amazon.com/Teach-everything-know-Nathan-Barry-ebook/dp/B00IVZUNQW/" target="_blank">teaching what he's learning</a>.  Please treat what you read here accordingly.</p>

<p>If you spot any errors or omissions, let me know at impostorsguides [at] gmail [dot] com.</p>

<h2>Background</h2>

<p>What's the first thing that happens when you type `bundle install` into the terminal and hit "Enter"?</p>

<p>This is the question which set me off on this entire project. For those unfamiliar with the `bundle install` command, it comes from the <a href="https://bundler.io/" target="_blank">Bundler library</a>.  Bundler provides "a consistent environment for Ruby projects by tracking and installing the exact gems and versions that are needed", according to its website.</p>

<p>Professionally, I work on a large Rails codebase with many contributors, and `bundle install` is one of the most common commands we find ourselves typing.  I was frustrated that I didn't know how this command worked under-the-hood.  Since I'm a big believer that <a href="https://ideas.time.com/2011/11/30/the-protege-effect/" target="_blank">"The best way to learn something is to explain it to someone else"</a>, I decided to blog about what I was learning, as I learned it.</p>

<p>As it happens, my deep-dive took me on a detour into the code for my Ruby version manager, named RBENV.  RBENV creates shim files for every Ruby command you enter, including “bundle”, and the first file I encountered ended up being this shim.</p>

<p>In the process of exploring this shim file (and RBENV’s code in general), I ended up learning a lot about the UNIX shell and Bash, the language RBENV is written in.  This might actually be more broadly-applicable than learning about Bundle, since Bash is much more broadly-used than Bundle.</p>

<p>Along the way, I kept a journal of all my wins, my frustrations, my questions, my a-ha moments, etc.  The document you're reading is an edited version of that journal.</p>

<h2>Starting Our Journey</h2>

<p>If we want to figure out what happens when we type “bundle install”, a good place to start is looking for where the “bundle” command lives.  I did this by running “which bundle” in my terminal.  I found the following:</p>

<pre><code>$ which bundle
/Users/richiethomas/.rbenv/shims/bundle
$ </code></pre>

<p>By default, the “which” command gives us just the first executable filepath it finds which matches the parameter we pass it (in this case, that parameter is “bundle”).  If we pass the “-a” flag, it will give us every executable filepath:</p>

<pre><code>$ which -a bundle
/Users/richiethomas/.rbenv/shims/bundle
/usr/bin/bundle
$ </code></pre>

<p>Here we see that there are two executable filepaths in total, and that the one located at /Users/richiethomas/.rbenv/shims/ is found before the one located at /usr/bin/bundle.  The filepath that is found first is the one that our computer will use to run our command, so this is the filepath we should inspect if we want to know what our machine is doing.</p>

<h2>Inspecting the filepath we found</h2>

<p>For my code editor, I sometimes use VS Code and sometimes use vim as my editor, and I have a terminal command named “code” which will open up a filepath I pass in VS Code.  So I run the following in my terminal:</p>

<pre><code>$ code /Users/richiethomas/.rbenv/shims/bundle</code></pre>

<p>When I do, I see the following in VS Code:</p>

<pre><code>#!/usr/bin/env bash
set -e
[ -n "$RBENV_DEBUG" ] && set -x

program="${0##*/}"
if [ "$program" = "ruby" ]; then
  for arg; do
    case "$arg" in
    -e* | -- ) break ;;
    */* )
      if [ -f "$arg" ]; then
        export RBENV_DIR="${arg%/*}"
        break
      fi
      ;;
    esac
  done
fi

export RBENV_ROOT="/Users/richiethomas/.rbenv"
exec "/Users/richiethomas/.rbenv/bin/rbenv" exec "$program" "$@"</code></pre>

<p>Yikes, that's a spicy meatball!</p>

<p>It'll take us quite a few posts to explain this code in its entirety.  For now, the important take-away is that this code comes from RBENV, <i>not</i> from the <code>bundle</code> command.  There are a few clues which let us know this is true:</p>

<ul>
  <li>the file's path is <code>/Users/richiethomas/.rbenv/shims/bundle</code>, which includes <code>.rbenv</code>.</li>
  <li>there are a few RBENV-specific references in the code, including environment variables named <code>RBENV_DIR</code> and <code>RBENV_ROOT</code>.</li>
</ul>

<p>As we'll come to learn, RBENV (and some other Ruby version managers) work by intercepting your call to the <code>ruby</code> command (or any other Ruby-specific command), doing some work to figure out which Ruby version you want to use, and then making sure that this Ruby version is used by the command you've typed.</p>

<h2>Moving On</h2>

<p>The first line of code in the above shim is:</p>

<pre><code>#!/usr/bin/env bash</code></pre>

<p>In the next section, we'll talk about what this code does.</p>